name: Deploy to EC2

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            set -e

            echo "ğŸš€ Starting Nhandare Backend deployment..."

            # Navigate to project directory
            cd ~/nhandare_server || mkdir -p ~/nhandare_server && cd ~/nhandare_server

            # Clone repository if it doesn't exist
            if [ ! -d .git ]; then
              echo "ğŸ“¥ Cloning repository..."
              git clone https://github.com/kudzilenett/nhandare_server.git .
            fi

            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin master

            # Create necessary directories
            echo "ğŸ“ Creating necessary directories..."
            mkdir -p uploads logs ssl

            # Set up environment file if it doesn't exist
            if [ ! -f .env.production ]; then
              echo "âš™ï¸ Setting up production environment file..."
              cp env.production.example .env.production
              echo "âš ï¸  IMPORTANT: Please edit .env.production with your production values!"
              echo "âš ï¸  Deployment will continue with default values for now..."
            fi

            # Ensure environment file has correct permissions
            chmod 600 .env.production

            # Verify environment file exists and is readable
            if [ ! -r .env.production ]; then
              echo "âŒ Error: .env.production file is not readable"
              exit 1
            fi

            # Check if Docker is running
            if ! docker info >/dev/null 2>&1; then
              echo "ğŸ³ Docker is not running. Starting Docker..."
              sudo systemctl start docker
              sudo systemctl enable docker
            fi

            # Check if docker-compose is available
            if ! command -v docker-compose &> /dev/null; then
              echo "ğŸ³ Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            # Check if containers are already running and healthy
            echo "ğŸ” Checking current container status..."
            if docker-compose -f docker-compose.prod.yml ps | grep -q "Up.*healthy"; then
              echo "âœ… Containers are already running and healthy. Skipping restart."
            else
              echo "ğŸ›‘ Stopping existing containers..."
              docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
            fi

            # Remove old images
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f

            # Build and start production services
            echo "ğŸ”¨ Building and starting production services..."
            docker-compose -f docker-compose.prod.yml up -d --build

            # Check if containers started successfully
            echo "ğŸ” Checking container status..."
            if ! docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
              echo "âŒ Some containers failed to start. Checking logs..."
              docker-compose -f docker-compose.prod.yml logs --tail=50
              exit 1
            fi

            # Quick health check to ensure backend is responding
            echo "ğŸ¥ Quick backend health check..."
            if curl -f http://localhost:3001/health >/dev/null 2>&1; then
              echo "âœ… Backend is responding to health checks"
            else
              echo "âŒ Backend is not responding. Checking logs..."
              docker-compose -f docker-compose.prod.yml logs backend --tail=20
              exit 1
            fi

            # Wait for services to be healthy
            echo "â³ Waiting for services to be healthy..."
            sleep 120

            # Check health with retries
            echo "ğŸ¥ Checking backend health..."
            max_attempts=8
            attempt=1

            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt of $max_attempts..."
              if curl -f http://localhost:3001/health; then
                echo "âœ… Health check passed on attempt $attempt!"
                break
              else
                echo "âŒ Health check failed on attempt $attempt"
                if [ $attempt -eq $max_attempts ]; then
                  echo "âŒ All health check attempts failed"
                  echo "ğŸ” Checking container logs for debugging..."
                  docker-compose -f docker-compose.prod.yml logs --tail=50
                  exit 1
                fi
                echo "Waiting 45 seconds before retry..."
                sleep 45
                attempt=$((attempt + 1))
              fi
            done

            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸŒ Your API is available at: http://$(curl -s ifconfig.me):3001"
            echo "ğŸ¥ Health check: http://$(curl -s ifconfig.me):3001/health"

      - name: Final Health Check
        run: |
          echo "ğŸ” Performing final health check..."
          sleep 45

          # Test the deployed API with retries
          max_attempts=3
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "Final health check attempt $attempt of $max_attempts..."
            if curl -f "http://${{ secrets.EC2_HOST }}:3001/health"; then
              echo "âœ… Final health check passed!"
              echo "ğŸ‰ Deployment successful! Your API is live at http://${{ secrets.EC2_HOST }}:3001"
              break
            else
              echo "âŒ Final health check failed on attempt $attempt"
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ All final health check attempts failed"
                echo "ğŸ” Check the deployment logs above for issues"
                exit 1
              fi
              echo "Waiting 20 seconds before retry..."
              sleep 20
              attempt=$((attempt + 1))
            fi
          done
